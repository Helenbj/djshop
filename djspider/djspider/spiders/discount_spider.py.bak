# -*- coding: utf-8 -*-
import scrapy
import re
import urllib.request
from scrapy.http import Request
from djspider.items import DjspiderItem
from lxml import etree
import chardet
import requests

class DiscountSpiderSpider(scrapy.Spider):
    name = 'discount_spider'
    allowed_domains = ['quanmama.com']
#    start_urls = ['http://www.quanmama.com/staticfiles/HomeMallPanel.html']

    def start_requests(self):
        fp = urllib.request.urlopen('http://www.quanmama.com/staticfiles/HomeMallPanel.html')
        print(fp.info())
        html = fp.read()
        print(chardet.detect(html))
        tree = etree.HTML(html)
        node_list = tree.xpath('//div[@class="mall-pane JPanel90"]/div[@class="list-shop-word"]/div')
        for node in node_list:
            category = node.xpath('h4/text()')[0].extract().strip('[').strip["'"].strip['\r'].strip['\n'].strip[' ']
            print(category)
            node_val = node.text.replace(' ','').replace('\n','')
            
        pat = '<div class="item">.*?</div>'
        sub_panel_data = re.compile(pat).findall(str(panel_data))
        for i in range(1, len(sub_panel_data)):
            if sub_pannel_data[i].xpath("/div/h4/text()") == "用车" or sub_pannel_data[i].xpath("/div/h4/text()") == "外卖" or sub_pannel_data[i].xpath("/div/h4/text()") == "电影票" or sub_pannel_data[i].xpath("/div/h4/text()") == "团购网站":
                pat1 = '<li class="item-stop">.*?</span>'
                elem_data = re.compile(pat1).findall(str(sub_pannel_data[i]))
                for j in range(1,len(elem_data)):
                    title = elem_data[j].xpath('/li/span/a/text()')
                    tourl = elem_data[j].xpath('/li/span/a/@href')
                    yield Request(tourl)
    
    def parse(self, response):
        item = DjspiderItem()
        item['title'] = response.xpath('//div[@class="clearfix"]/div[@class="clear"]/div[@class="w990 clear"]/div[@class="container"]/div[@class="left_side"]/div[@class="coupon_block"]/div[@class="main_l_c_c body"]/ul/li/div[@class=coupon]/span/span[@class="description"]/a/@title')
        item['lkurl'] = response.xpath('//div[@class="clearfix"]/div[@class="clear"]/div[@class="w990 clear"]/div[@class="container"]/div[@class="left_side"]/div[@class="coupon_block"]/div[@class="main_l_c_c body"]/ul/li/div[@class=coupon]/span/span[@class="description"]/a/@href')
        item['imgurl'] = response.xpath('//div[@class="clearfix"]/div[@class="clear"]/div[@class="w990 clear"]/div[@class="container"]/div[@class="left_side"]/div[@class="coupon_block"]/div[@class="main_l_c_c body"]/ul/li/div[@class=coupon]/span/span[@class="store-logo"]/a/img/@src')
        item['keywords'] = response.xpath('//div[@class="clearfix"]/div[@class="clear"]/div[@class="w990 clear"]/div[@class="container"]/div[@class="left_side"]/div[@class="coupon_block"]/div[@class="main_l_c_c body"]/ul/li/div[@class=coupon]/span/span[@class="store-logo"]/a/img/@title')
        yield item
        
